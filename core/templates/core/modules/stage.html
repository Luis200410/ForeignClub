{% extends "core/base.html" %}
{% block title %}{{ stage.label }} Â· {{ module.title }}{% endblock %}
{% block content %}
<section class="container-xl py-7">
    <div class="row g-5">
        <div class="col-lg-8">
            <article class="module-card glass-panel p-5 p-lg-6 mb-5" data-tilt="3">
                <p class="eyebrow mb-2">Stage {{ stage.order }} Â· {{ course.title }}</p>
                <h1 class="h3 fw-bold tracking-tight mb-2">{{ stage.label }} Â· {{ stage.tagline }}</h1>
                <p class="text-white-50 mb-4">{{ stage.summary }}</p>

                {% if stage_key == "launch-pad" %}
                    <div class="module-stage" data-animate="fade-up" data-animate-delay="0.05s">
                        <div class="stage-header">
                            <div>
                                <p class="eyebrow mb-1">NotebookLM missions</p>
                                <h2 class="h5 tracking-tight mb-1">Complete all six warmups before Friday</h2>
                            </div>
                            <p class="text-white-50 small mb-0">Links open in a new tab. Update with your NotebookLM workspace when ready.</p>
                        </div>
                        <div class="todo-grid">
                            {% if launch_pad_tasks %}
                                {% for task in launch_pad_tasks %}
                                    <form
                                        class="todo-card js-stage-task-toggle{% if task.completed %} todo-card--done{% endif %}"
                                        action="{% url 'course_module_stage_task_toggle' course.slug module.order stage_key task.index %}"
                                        method="post"
                                        data-stage-key="{{ stage_key }}"
                                    >
                                        {% csrf_token %}
                                        <div class="todo-card__body">
                                            <span class="todo-step">0{{ task.index }}</span>
                                            <span class="todo-title">{{ task.title }}</span>
                                            {% if task.url %}
                                                <a class="todo-link" href="{{ task.url }}" target="_blank" rel="noopener">
                                                    Open NotebookLM
                                                </a>
                                            {% else %}
                                                <span class="todo-link">Open NotebookLM</span>
                                            {% endif %}
                                        </div>
                                        <button
                                            class="todo-check{% if task.completed %} todo-check--completed{% endif %}"
                                            type="submit"
                                            aria-pressed="{% if task.completed %}true{% else %}false{% endif %}"
                                        >
                                            {% if task.completed %}Done{% else %}Mark Done{% endif %}
                                        </button>
                                    </form>
                                {% endfor %}
                            {% else %}
                                {% for resource in pre_session_resources %}
                                    <a class="todo-card" href="{{ resource.url }}" target="_blank" rel="noopener">
                                        <span class="todo-step">0{{ forloop.counter }}</span>
                                        <span class="todo-title">{{ resource.title }}</span>
                                        <span class="todo-link">Open NotebookLM</span>
                                    </a>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                {% elif stage_key == "flight-deck" %}
                    <div class="module-stage" data-animate="fade-up" data-animate-delay="0.05s">
                        <div class="stage-header">
                            <div>
                                <p class="eyebrow mb-1">Live selections</p>
                                <h2 class="h5 tracking-tight mb-1">Lock your Friday studios</h2>
                            </div>
                            <p class="text-white-50 small mb-0">Knock out these three moves so you're ready to go live.</p>
                        </div>
                        {% if flight_deck_tasks %}
                            <div class="todo-grid">
                                {% for task in flight_deck_tasks %}
                                {% if task.type == "scheduler" %}
                                        <div class="todo-card todo-card--scheduler{% if task.completed %} todo-card--done{% endif %}"
                                            data-cancel-url="{{ task.cancel_url }}">
                                            <div class="todo-card__body">
                                                <span class="todo-step">0{{ task.index }}</span>
                                                <span class="todo-title">{{ task.title }}</span>
                                                {% if task.subtitle %}
                                                    <p class="text-white-50 small mb-2">{{ task.subtitle }}</p>
                                                {% endif %}
                                                {% if task.meeting_options %}
                                                    <div class="meeting-option-grid">
                                                        {% for option in task.meeting_options %}
                                                            <form
                                                                class="meeting-option js-meeting-select{% if option.id == task.selected_meeting_id %} meeting-option--active{% endif %}"
                                                                action="{% url 'course_module_meeting_select' course.slug module.order %}"
                                                                method="post"
                                                                data-meeting-id="{{ option.id }}"
                                                            >
                                                                {% csrf_token %}
                                                                <input type="hidden" name="meeting_id" value="{{ option.id }}">
                                                                <div class="meeting-option__meta">
                                                                    <h3 class="h6 mb-1">{{ option.title|default:"Live mission" }}</h3>
                                                                    <p class="text-white-50 small mb-2">{{ option.scheduled_for|date:"M j, Y Â· H:i" }} Â· {{ option.duration_minutes }} min</p>
                                                                    {% if option.agenda %}
                                                                        <p class="text-white-50 small mb-0">{{ option.agenda }}</p>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="meeting-option__actions">
                                                                    <button class="todo-check" type="submit" data-default-label="Join this slot">
                                                                        {% if option.id == task.selected_meeting_id %}Selected{% else %}Join this slot{% endif %}
                                                                    </button>
                                                                </div>
                                                            </form>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <p class="text-white-50 small mb-0">Schedule for this week goes live shortly.</p>
                                                {% endif %}
                                                <div class="meeting-summary mt-3" data-meeting-summary>
                                                    <p class="meeting-summary__details{% if not task.selected_meeting %} d-none{% endif %}" data-meeting-summary-details>
                                                        <strong data-meeting-summary-text>
                                                            {% if task.selected_meeting %}
                                                                {{ task.selected_meeting.scheduled_for|date:"M j, Y Â· H:i" }} Â· {{ task.selected_meeting.duration_minutes }} min{% if task.selected_meeting.title %} Â· {{ task.selected_meeting.title }}{% endif %}
                                                            {% endif %}
                                                        </strong>
                                                    </p>
                                                    <p class="text-white-50 small mb-0{% if task.selected_meeting %} d-none{% endif %}" data-meeting-summary-empty>No slot selected yet.</p>
                                                    <div
                                                        class="meeting-summary__actions{% if not task.selected_meeting %} d-none{% endif %}"
                                                        data-meeting-summary-actions
                                                        data-meeting-assistant-window
                                                        {% if task.assistant_start %}data-assistant-start="{{ task.assistant_start|date:'c' }}"{% endif %}
                                                        {% if task.assistant_end %}data-assistant-end="{{ task.assistant_end|date:'c' }}"{% endif %}
                                                    >
                                                        {% if task.selected_meeting %}
                                                            {% if task.assistant_url %}
                                                                <a
                                                                    class="todo-check todo-check--cta meeting-assistant-trigger{% if not task.assistant_available %} d-none{% endif %}"
                                                                    href="{{ task.assistant_url }}"
                                                                    target="_blank"
                                                                    rel="noopener"
                                                                    data-meeting-assistant
                                                                >
                                                                    Launch Mission Assistant
                                                                </a>
                                                            {% endif %}
                                                            {% if task.can_cancel %}
                                                                <form class="meeting-cancel-form js-meeting-cancel" action="{{ task.cancel_url }}" method="post">
                                                                    {% csrf_token %}
                                                                    <input type="hidden" name="meeting_id" value="{{ task.selected_meeting.id }}">
                                                                    <button class="todo-check todo-check--ghost" type="submit">Cancel slot</button>
                                                                </form>
                                                                <p class="text-white-50 small mb-0 mt-2">You can un-join up to 48h before go-live.</p>
                                                            {% else %}
                                                                <p class="text-white-50 small mb-0">Changes within 48 hours require a fee â€” contact support.</p>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% elif task.type == "notebook" %}
                                        <form
                                            class="todo-card todo-card--flight js-stage-task-toggle{% if task.completed %} todo-card--done{% endif %}"
                                            action="{% url 'course_module_stage_task_toggle' course.slug module.order stage_key task.index %}"
                                            method="post"
                                            data-stage-key="{{ stage_key }}"
                                        >
                                            {% csrf_token %}
                                            <div class="todo-card__body">
                                                <span class="todo-step">0{{ task.index }}</span>
                                                <span class="todo-title">{{ task.title }}</span>
                                                {% if task.subtitle %}
                                                    <p class="text-white-50 small mb-2">{{ task.subtitle }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="todo-card__actions">
                                                <a class="todo-check todo-check--cta" href="{{ task.url }}" target="_blank" rel="noopener">
                                                    {{ task.link_label }}
                                                </a>
                                                <button
                                                    class="todo-check{% if task.completed %} todo-check--completed{% endif %}"
                                                    type="submit"
                                                    aria-pressed="{% if task.completed %}true{% else %}false{% endif %}"
                                                >
                                                    {% if task.completed %}Done{% else %}Mark Done{% endif %}
                                                </button>
                                            </div>
                                        </form>
                                    {% else %}
                                        <form
                                            class="todo-card todo-card--recorder js-stage-task-toggle{% if task.completed %} todo-card--done{% endif %}"
                                            action="{% url 'course_module_stage_task_toggle' course.slug module.order stage_key task.index %}"
                                            method="post"
                                            data-stage-key="{{ stage_key }}"
                                        >
                                            {% csrf_token %}
                                            <div class="todo-card__body js-recorder-card">
                                                <span class="todo-step">0{{ task.index }}</span>
                                                <span class="todo-title">{{ task.title }}</span>
                                                {% if task.subtitle %}
                                                    <p class="text-white-50 small mb-2">{{ task.subtitle }}</p>
                                                {% endif %}
                                                <div class="recorder-panel">
                                                    <div class="recorder-controls">
                                                        <button class="todo-check todo-check--ghost" type="button" data-recorder-action="start">Start Recording</button>
                                                        <button class="todo-check todo-check--ghost" type="button" data-recorder-action="stop">Stop</button>
                                                        <button class="todo-check todo-check--ghost" type="button" data-recorder-action="play">Play</button>
                                                        <a class="todo-check todo-check--ghost js-recorder-download" href="#" download="flight-deck-recording.webm" hidden>Download</a>
                                                    </div>
                                                    <p class="recorder-status js-recorder-status text-white-50 small mb-0">Recorder idle.</p>
                                                    <audio class="recorder-audio" controls hidden></audio>
                                                </div>
                                            </div>
                                            <div class="todo-card__actions">
                                                <button
                                                    class="todo-check{% if task.completed %} todo-check--completed{% endif %}"
                                                    type="submit"
                                                    aria-pressed="{% if task.completed %}true{% else %}false{% endif %}"
                                                >
                                                    {% if task.completed %}Done{% else %}Mark Done{% endif %}
                                                </button>
                                            </div>
                                        </form>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-white-50 small mb-0">Live studio checklist will be announced shortly.</p>
                        {% endif %}
                        {% if meeting_activities %}
                            <div class="meeting-activity-board" data-animate="fade-up" data-animate-delay="0.12s">
                                <div class="meeting-activity-board__header">
                                    <p class="eyebrow mb-1">Inside the studio</p>
                                    <h3 class="h5 tracking-tight mb-2">Live mission run of show</h3>
                                    <p class="text-white-50 small mb-0">Mentors will guide you through these flows once the session begins.</p>
                                </div>
                                <div class="meeting-activity-board__list">
                                    {% for activity in meeting_activities %}
                                        <div class="meeting-activity-item" data-activity-order="{{ activity.index }}">
                                            <span class="meeting-activity-item__step">0{{ activity.index }}</span>
                                            <div class="meeting-activity-item__content">
                                                <h4 class="h6 mb-1">{{ activity.title }}</h4>
                                                {% if activity.description %}
                                                    <p class="text-white-50 small mb-0">{{ activity.description }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% elif stage_key == "afterburner" %}
                    <div class="module-stage" data-animate="fade-up" data-animate-delay="0.05s">
                        <div class="stage-header">
                            <div>
                                <p class="eyebrow mb-1">Retention lab</p>
                                <h2 class="h5 tracking-tight mb-1">Play, review, and lock in the gains</h2>
                            </div>
                            <p class="text-white-50 small mb-0">Blend games with spaced repetition to encode what you learned.</p>
                        </div>
                        <div class="afterburner-techniques-grid">
                            {% for technique in afterburner_cards %}
                                <form
                                    class="todo-card afterburner-card js-stage-task-toggle{% if technique.completed %} afterburner-card--done{% endif %}"
                                    action="{% url 'course_module_stage_task_toggle' course.slug module.order stage_key technique.index %}"
                                    method="post"
                                >
                                    {% csrf_token %}
                                    <div class="afterburner-card__body">
                                        <span class="afterburner-step">0{{ technique.index }}</span>
                                        <h3 class="h6 mb-1">{{ technique.title }}</h3>
                                        <p class="text-white-50 small mb-0">{{ technique.description }}</p>
                                    </div>
                                    <button
                                        class="todo-check{% if technique.completed %} todo-check--completed{% endif %}"
                                        type="submit"
                                        aria-pressed="{% if technique.completed %}true{% else %}false{% endif %}"
                                    >
                                        {% if technique.completed %}Done{% else %}Mark Done{% endif %}
                                    </button>
                                </form>
                            {% endfor %}
                        </div>
                        {% if afterburner_game_card %}
                            <form
                                class="todo-card afterburner-card afterburner-game-card js-stage-task-toggle{% if afterburner_game_card.completed %} afterburner-card--done{% endif %}"
                                action="{% url 'course_module_stage_task_toggle' course.slug module.order stage_key afterburner_game_card.index %}"
                                method="post"
                            >
                                {% csrf_token %}
                                <div class="afterburner-card__body">
                                    <span class="afterburner-step">0{{ afterburner_game_card.index }}</span>
                                    <h3 class="h6 mb-2">{{ afterburner_game_card.title }}</h3>
                                    <p class="text-white-50 small mb-2">{{ afterburner_game_card.description }}</p>
                                    {% if afterburner_game_card.game_type == 'letter-sequence' %}
                                        <div
                                            class="letter-sequence-game"
                                            data-word="{{ afterburner_game_card.word|default:''|upper }}"
                                            data-definition="{{ afterburner_game_card.definition|default:''|escape }}"
                                        >
                                            <div class="letter-sequence__bank" data-letter-bank></div>
                                            <div class="letter-sequence__answer" data-letter-answer></div>
                                            <div class="letter-sequence__controls">
                                                <button class="todo-check todo-check--ghost" type="button" data-letter-reset>Reset</button>
                                            </div>
                                            <p class="text-danger small mb-0 d-none" data-letter-error>Not quite right. Reset and try again.</p>
                                            <p class="text-white-50 small mb-0 d-none" data-letter-definition></p>
                                            <p class="text-white-50 small mb-0 d-none" data-letter-missing>Game content coming soon.</p>
                                        </div>
                                    {% elif afterburner_game_card.game_type == 'adaptive-flashcards' %}
                                        <div
                                            class="adaptive-flashcard-game"
                                            data-flashcard-queue-url="{{ afterburner_game_card.flashcards_api.queue }}"
                                            data-flashcard-log-url="{{ afterburner_game_card.flashcards_api.log }}"
                                        >
                                            <div class="flashcard-stage" data-flashcard-stage>
                                                <div class="flashcard-card" data-flashcard-card>
                                                    <div class="flashcard-face flashcard-face--front" data-flashcard-face="front">
                                                        <div class="flashcard-media" data-flashcard-image-wrapper>
                                                            <img class="flashcard-image" data-flashcard-image src="" alt="Flashcard prompt" hidden>
                                                            <div class="flashcard-placeholder" data-flashcard-placeholder>Tap to flip</div>
                                                        </div>
                                                    </div>
                                                    <div class="flashcard-face flashcard-face--back" data-flashcard-face="back">
                                                        <div class="flashcard-word" data-flashcard-word></div>
                                                        <button class="todo-check todo-check--ghost" type="button" data-flashcard-audio>Play audio</button>
                                                        <p class="text-white-50 small mb-0 flashcard-pronounce-hint">Listen and repeat aloud three times.</p>
                                                    </div>
                                                </div>
                                                <div class="flashcard-empty d-none" data-flashcard-empty>
                                                    <div class="flashcard-empty__icon" aria-hidden="true">ðŸŽ‰</div>
                                                    <p class="h6 mb-1">All done for now!</p>
                                                    <p class="text-white-50 small mb-3" data-flashcard-summary>Great job reviewing today's words.</p>
                                                    <button class="todo-check" type="button" data-flashcard-replay hidden>Replay missed cards</button>
                                                </div>
                                            </div>
                                            <div class="flashcard-scoreboard" data-flashcard-scoreboard>
                                                <div class="flashcard-score" data-flashcard-score>0 pts</div>
                                                <div class="flashcard-streak" data-flashcard-streak>Streak Â· 0</div>
                                                <div class="flashcard-reviewed" data-flashcard-reviewed>Reviewed Â· 0</div>
                                            </div>
                                            <div class="flashcard-controls" data-flashcard-controls>
                                                <button class="todo-check todo-check--ghost" type="button" data-flashcard-action="reveal">Flip card</button>
                                                <div class="flashcard-response-buttons">
                                                    <button class="todo-check todo-check--cta" type="button" data-flashcard-action="knew">I knew it</button>
                                                    <button class="todo-check" type="button" data-flashcard-action="didnt">I didn't</button>
                                                </div>
                                            </div>
                                            <p class="text-white-50 small mb-0 d-none" data-flashcard-status>Loading cardsâ€¦</p>
                                        </div>
                                    {% else %}
                                        <p class="text-white-50 small mb-0">Interactive game coming soon.</p>
                                    {% endif %}
                                </div>
                                <button
                                    class="todo-check{% if afterburner_game_card.completed %} todo-check--completed{% endif %}"
                                    type="submit"
                                    aria-pressed="{% if afterburner_game_card.completed %}true{% else %}false{% endif %}"
                                >
                                    {% if afterburner_game_card.completed %}Completed{% else %}Mark Done{% endif %}
                                </button>
                            </form>
                        {% endif %}
                    </div>
                {% endif %}
            </article>
        </div>
        <div class="col-lg-4">
            <aside class="glass-panel p-4 p-lg-5" data-tilt="4">
                <p class="eyebrow mb-2">Stage navigation</p>
                <div class="stage-nav d-grid gap-2 mb-4">
                    {% for item in stage_cards %}
                        {% if item.is_unlocked %}
                            <a
                                class="stage-nav-link{% if item.is_active %} active{% endif %}"
                                href="{{ item.url }}"
                                data-stage-nav="{{ item.key }}"
                                data-stage-url="{{ item.url }}"
                            >
                                <span class="stage-nav-text">
                                    <span class="stage-nav-label">Stage {{ item.order }}</span>
                                    <span class="stage-nav-title">{{ item.label }}</span>
                                </span>
                                <span class="stage-nav-lock module-lock module-lock--compact" aria-hidden="true">
                                    <svg class="lock-icon lock-icon--closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M8.5 10.5v-2.8a3.5 3.5 0 0 1 7 0v2.8" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                    <svg class="lock-icon lock-icon--open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M15.5 10.5v-2.8a3.5 3.5 0 1 0-7 0" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                </span>
                            </a>
                        {% else %}
                            <span
                                class="stage-nav-link stage-nav-link--locked{% if item.is_active %} active{% endif %}"
                                role="button"
                                aria-disabled="true"
                                tabindex="-1"
                                data-stage-nav="{{ item.key }}"
                                data-stage-url="{{ item.url }}"
                            >
                                <span class="stage-nav-text">
                                    <span class="stage-nav-label">Stage {{ item.order }}</span>
                                    <span class="stage-nav-title">{{ item.label }}</span>
                                </span>
                                <span class="stage-nav-lock module-lock module-lock--compact" aria-hidden="true">
                                    <svg class="lock-icon lock-icon--closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M8.5 10.5v-2.8a3.5 3.5 0 0 1 7 0v2.8" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                    <svg class="lock-icon lock-icon--open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M15.5 10.5v-2.8a3.5 3.5 0 1 0-7 0" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                </span>
                            </span>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="d-grid gap-2">
                    <a class="btn btn-light" href="{% url 'course_module' course.slug module.order %}">Back to week overview</a>
                    <a class="btn btn-outline-light" href="{% url 'course_detail' course.slug %}">All weeks</a>
                </div>
            </aside>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    <script>
        (function () {
            const toArray = function (list) {
                return Array.prototype.slice.call(list || []);
            };

            const unique = function (items) {
                const seen = Object.create(null);
                const result = [];
                for (let idx = 0; idx < items.length; idx += 1) {
                    const value = items[idx];
                    if (!value || seen[value]) {
                        continue;
                    }
                    seen[value] = true;
                    result.push(value);
                }
                return result;
            };

            const toggleForms = document.querySelectorAll('.js-stage-task-toggle');

            const updateNav = function (stageKey, unlocked) {
                const navEl = document.querySelector('[data-stage-nav="' + stageKey + '"]');
                if (!navEl) {
                    return;
                }

                const stageUrl = navEl.dataset.stageUrl || navEl.getAttribute('href') || '';

                if (unlocked) {
                    if (navEl.tagName === 'SPAN') {
                        const link = document.createElement('a');
                        const linkClasses = toArray(navEl.classList)
                            .filter(function (className) {
                                return className !== 'stage-nav-link--locked';
                            });
                        link.className = linkClasses.join(' ') || 'stage-nav-link';
                        if (!link.classList.contains('stage-nav-link')) {
                            link.classList.add('stage-nav-link');
                        }
                        if (navEl.classList.contains('active')) {
                            link.classList.add('active');
                        }
                        link.href = stageUrl;
                        link.dataset.stageNav = stageKey;
                        link.dataset.stageUrl = stageUrl;
                        link.classList.remove('stage-nav-link--locked');
                        link.innerHTML = navEl.innerHTML;
                        navEl.replaceWith(link);
                        return;
                    }
                    navEl.classList.remove('stage-nav-link--locked');
                    if (stageUrl) {
                        navEl.setAttribute('href', stageUrl);
                    }
                    navEl.removeAttribute('aria-disabled');
                    navEl.removeAttribute('tabindex');
                    return;
                }

                if (navEl.tagName === 'A') {
                    const span = document.createElement('span');
                    const spanClasses = toArray(navEl.classList);
                    spanClasses.push('stage-nav-link--locked');
                    span.className = unique(spanClasses).join(' ');
                    if (!span.classList.contains('stage-nav-link')) {
                        span.classList.add('stage-nav-link');
                    }
                    if (navEl.classList.contains('active')) {
                        span.classList.add('active');
                    }
                    span.dataset.stageNav = stageKey;
                    span.dataset.stageUrl = stageUrl;
                    span.setAttribute('role', 'button');
                    span.setAttribute('aria-disabled', 'true');
                    span.setAttribute('tabindex', '-1');
                    span.innerHTML = navEl.innerHTML;
                    navEl.replaceWith(span);
                }
            };

            toggleForms.forEach(function (form) {
                form.dataset.autoLock = form.dataset.autoLock || 'false';
                form.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const submitButton = form.querySelector('button[type="submit"]');
                    if (!submitButton) {
                        return;
                    }
                    const csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
                    const csrfToken = csrfInput ? csrfInput.value : '';
                    const formData = new FormData(form);

                    let shouldLock = false;
                    submitButton.disabled = true;

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: formData,
                    })
                        .then(function (response) {
                            if (response.status === 403) {
                                return response.json().then(function (data) {
                                    if (data && data.redirect_url) {
                                        window.location.href = data.redirect_url;
                                    }
                                    throw new Error('Access denied');
                                });
                            }
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(function (data) {
                            const completed = Boolean(data.completed);
                            form.classList.toggle('todo-card--done', completed);
                            form.classList.toggle('afterburner-card--done', completed);
                            submitButton.classList.toggle('todo-check--completed', completed);
                            shouldLock = form.dataset.autoLock === 'true';
                            if (shouldLock) {
                                submitButton.textContent = 'Completed';
                                submitButton.disabled = true;
                            } else {
                                submitButton.textContent = completed ? 'Done' : 'Mark Done';
                            }
                            submitButton.setAttribute('aria-pressed', completed ? 'true' : 'false');

                            if (data.stage_unlocks && typeof data.stage_unlocks === 'object') {
                                if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'flight-deck')) {
                                    updateNav('flight-deck', Boolean(data.stage_unlocks['flight-deck']));
                                }
                                if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'afterburner')) {
                                    updateNav('afterburner', Boolean(data.stage_unlocks['afterburner']));
                                }
                            }
                        })
                        .catch(function (error) {
                            console.error('Unable to toggle task state via AJAX:', error);
                        })
                        .finally(function () {
                            if (!shouldLock) {
                                submitButton.disabled = false;
                            }
                        });
                });
            });

            const schedulerCard = document.querySelector('.todo-card--scheduler');
            const meetingSummary = schedulerCard ? schedulerCard.querySelector('[data-meeting-summary]') : null;
            const csrfTokenGlobal = document.querySelector('input[name=csrfmiddlewaretoken]') ? document.querySelector('input[name=csrfmiddlewaretoken]').value : '';
            let assistantIntervalRef = null;

            const refreshAssistantWindows = function () {
                const blocks = document.querySelectorAll('[data-meeting-assistant-window]');
                if (!blocks.length) {
                    return;
                }
                const now = new Date();
                blocks.forEach(function (block) {
                    const trigger = block.querySelector('.meeting-assistant-trigger');
                    if (!trigger) {
                        return;
                    }
                    const startStr = block.getAttribute('data-assistant-start') || '';
                    const endStr = block.getAttribute('data-assistant-end') || '';
                    if (!startStr || !endStr) {
                        trigger.classList.add('d-none');
                        return;
                    }
                    const startTime = new Date(startStr);
                    const endTime = new Date(endStr);
                    if (Number.isNaN(startTime.getTime()) || Number.isNaN(endTime.getTime())) {
                        trigger.classList.add('d-none');
                        return;
                    }
                    const shouldShow = now >= startTime && now <= endTime;
                    trigger.classList.toggle('d-none', !shouldShow);
                });
            };

            const ensureAssistantInterval = function () {
                if (assistantIntervalRef) {
                    return;
                }
                const assistantBlocks = document.querySelectorAll('[data-meeting-assistant-window]');
                const hasWindow = Array.prototype.some.call(assistantBlocks, function (block) {
                    return block.hasAttribute('data-assistant-start') && block.hasAttribute('data-assistant-end');
                });
                if (!hasWindow) {
                    return;
                }
                refreshAssistantWindows();
                assistantIntervalRef = window.setInterval(refreshAssistantWindows, 30000);
            };

            const updateOptionStates = function (selectedId) {
                const meetingForms = document.querySelectorAll('.js-meeting-select');
                meetingForms.forEach(function (form) {
                    const button = form.querySelector('button[type="submit"]');
                    const defaultLabel = button ? button.getAttribute('data-default-label') || 'Join this slot' : 'Join this slot';
                    const formMeetingId = form.dataset.meetingId;
                    const isActive = selectedId && String(formMeetingId) === String(selectedId);
                    form.classList.toggle('meeting-option--active', Boolean(isActive));
                    if (button) {
                        button.textContent = isActive ? 'Selected' : defaultLabel;
                        button.disabled = false;
                    }
                });
            };

            const setSelectedMeetingUI = function (meetingData) {
                if (!schedulerCard || !meetingSummary) {
                    return;
                }
                const details = meetingSummary.querySelector('[data-meeting-summary-details]');
                const detailText = meetingSummary.querySelector('[data-meeting-summary-text]');
                const empty = meetingSummary.querySelector('[data-meeting-summary-empty]');
                const actions = meetingSummary.querySelector('[data-meeting-summary-actions]');

                if (meetingData) {
                    schedulerCard.classList.add('todo-card--done');
                    if (details) {
                        details.classList.remove('d-none');
                    }
                    if (detailText) {
                        const titlePart = meetingData.title ? ' Â· ' + meetingData.title : '';
                        detailText.textContent = meetingData.scheduled_for + ' Â· ' + meetingData.duration_minutes + ' min' + titlePart;
                    }
                    if (empty) {
                        empty.classList.add('d-none');
                    }
                    if (actions) {
                        actions.classList.remove('d-none');
                        actions.innerHTML = '';
                        delete actions.dataset.assistantStart;
                        delete actions.dataset.assistantEnd;

                        const hasAssistantWindow = Boolean(
                            meetingData.assistant_start &&
                                meetingData.assistant_end &&
                                meetingData.assistant_url
                        );

                        if (hasAssistantWindow) {
                            actions.dataset.assistantStart = meetingData.assistant_start;
                            actions.dataset.assistantEnd = meetingData.assistant_end;

                            const assistantButton = document.createElement('a');
                            assistantButton.className = 'todo-check todo-check--cta meeting-assistant-trigger';
                            assistantButton.href = meetingData.assistant_url;
                            assistantButton.target = '_blank';
                            assistantButton.rel = 'noopener';
                            assistantButton.dataset.meetingAssistant = 'true';
                            assistantButton.textContent = 'Launch Mission Assistant';
                            if (!meetingData.assistant_available) {
                                assistantButton.classList.add('d-none');
                            }
                            actions.appendChild(assistantButton);
                        }

                        if (meetingData.can_cancel) {
                            const cancelForm = document.createElement('form');
                            cancelForm.className = 'meeting-cancel-form js-meeting-cancel';
                            cancelForm.action = schedulerCard.dataset.cancelUrl || '';
                            cancelForm.method = 'post';

                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = 'csrfmiddlewaretoken';
                            csrfInput.value = csrfTokenGlobal;
                            cancelForm.appendChild(csrfInput);

                            const meetingIdInput = document.createElement('input');
                            meetingIdInput.type = 'hidden';
                            meetingIdInput.name = 'meeting_id';
                            meetingIdInput.value = meetingData.id;
                            cancelForm.appendChild(meetingIdInput);

                            const cancelButton = document.createElement('button');
                            cancelButton.className = 'todo-check todo-check--ghost';
                            cancelButton.type = 'submit';
                            cancelButton.textContent = 'Cancel slot';
                            cancelForm.appendChild(cancelButton);

                            actions.appendChild(cancelForm);

                            const note = document.createElement('p');
                            note.className = 'text-white-50 small mb-0 mt-2';
                            note.textContent = 'You can un-join up to 48h before go-live.';
                            actions.appendChild(note);
                        } else {
                            const feeNote = document.createElement('p');
                            feeNote.className = 'text-white-50 small mb-0';
                            feeNote.textContent = 'Changes within 48 hours require a fee â€” contact support.';
                            actions.appendChild(feeNote);
                        }
                        refreshAssistantWindows();
                        ensureAssistantInterval();
                    }
                } else {
                    schedulerCard.classList.remove('todo-card--done');
                    if (details) {
                        details.classList.add('d-none');
                    }
                    if (detailText) {
                        detailText.textContent = '';
                    }
                    if (empty) {
                        empty.classList.remove('d-none');
                    }
                    if (actions) {
                        actions.classList.add('d-none');
                        actions.innerHTML = '';
                        delete actions.dataset.assistantStart;
                        delete actions.dataset.assistantEnd;
                    }
                }

                refreshAssistantWindows();
                bindCancelForms();
            };

            const bindCancelForms = function () {
                const cancelForms = schedulerCard ? schedulerCard.querySelectorAll('.js-meeting-cancel') : [];
                cancelForms.forEach(function (form) {
                    if (form.dataset.bound === 'true') {
                        return;
                    }
                    form.dataset.bound = 'true';
                    form.addEventListener('submit', function (event) {
                        event.preventDefault();
                        const csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
                        const csrfToken = csrfInput ? csrfInput.value : csrfTokenGlobal;
                        const formData = new FormData(form);
                        const submitButton = form.querySelector('button[type="submit"]');

                        if (!window.confirm('Cancel this mission slot? Within 48 hours fees may apply.')) {
                            return;
                        }

                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.textContent = 'Processingâ€¦';
                        }

                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json',
                                'X-CSRFToken': csrfToken,
                            },
                            body: formData,
                        })
                            .then(function (response) {
                                if (response.status === 403) {
                                    return response.json().then(function (data) {
                                        if (data && data.redirect_url) {
                                            window.location.href = data.redirect_url;
                                        }
                                        throw new Error('Access denied');
                                    });
                                }
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(function (data) {
                                setSelectedMeetingUI(null);
                                updateOptionStates(null);
                                if (data.stage_unlocks && typeof data.stage_unlocks === 'object') {
                                    if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'flight-deck')) {
                                        updateNav('flight-deck', Boolean(data.stage_unlocks['flight-deck']));
                                    }
                                    if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'afterburner')) {
                                        updateNav('afterburner', Boolean(data.stage_unlocks['afterburner']));
                                    }
                                }
                            })
                            .catch(function (error) {
                                console.error('Unable to cancel meeting slot:', error);
                                alert('We could not cancel this slot. Please contact support if the issue persists.');
                            })
                            .finally(function () {
                                if (submitButton) {
                                    submitButton.disabled = false;
                                    submitButton.textContent = 'Cancel slot';
                                }
                            });
                    });
                });
            };

            bindCancelForms();

            refreshAssistantWindows();
            ensureAssistantInterval();

            const initialActiveForm = document.querySelector('.js-meeting-select.meeting-option--active');
            updateOptionStates(initialActiveForm ? initialActiveForm.dataset.meetingId : null);

            const meetingForms = document.querySelectorAll('.js-meeting-select');
            meetingForms.forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (!submitButton) {
                        return;
                    }
                    const defaultLabel = submitButton.getAttribute('data-default-label') || 'Join this slot';
                    if (!window.confirm('Confirm this live mission slot? Within 48 hours changes require a fee.')) {
                        submitButton.disabled = false;
                        submitButton.textContent = defaultLabel;
                        return;
                    }
                    submitButton.disabled = true;
                    submitButton.textContent = 'Bookingâ€¦';
                    const csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
                    const csrfToken = csrfInput ? csrfInput.value : csrfTokenGlobal;
                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: formData,
                    })
                        .then(function (response) {
                            if (response.status === 403) {
                                return response.json().then(function (data) {
                                    if (data && data.redirect_url) {
                                        window.location.href = data.redirect_url;
                                    }
                                    throw new Error('Access denied');
                                });
                            }
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(function (data) {
                            updateOptionStates(data.selected_meeting ? data.selected_meeting.id : null);
                            if (data.selected_meeting) {
                                setSelectedMeetingUI(data.selected_meeting);
                            }
                            if (data.stage_unlocks && typeof data.stage_unlocks === 'object') {
                                if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'flight-deck')) {
                                    updateNav('flight-deck', Boolean(data.stage_unlocks['flight-deck']));
                                }
                                if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'afterburner')) {
                                    updateNav('afterburner', Boolean(data.stage_unlocks['afterburner']));
                                }
                            }
                        })
                        .catch(function (error) {
                            console.error('Unable to book meeting slot:', error);
                            alert('We could not lock this slot. Please try again or contact support.');
                        })
                        .finally(function () {
                            submitButton.disabled = false;
                            const isActive = form.classList.contains('meeting-option--active');
                            submitButton.textContent = isActive ? 'Selected' : defaultLabel;
                        });
                });
            });

            const flashcardGames = document.querySelectorAll('.adaptive-flashcard-game');
            flashcardGames.forEach(function (wrapper) {
                const queueUrl = wrapper.getAttribute('data-flashcard-queue-url');
                const logUrl = wrapper.getAttribute('data-flashcard-log-url');
                if (!queueUrl || !logUrl) {
                    return;
                }

                const form = wrapper.closest('form');
                const cardEl = wrapper.querySelector('[data-flashcard-card]');
                const emptyEl = wrapper.querySelector('[data-flashcard-empty]');
                const summaryEl = wrapper.querySelector('[data-flashcard-summary]');
                const replayBtn = wrapper.querySelector('[data-flashcard-replay]');
                const statusEl = wrapper.querySelector('[data-flashcard-status]');
                const scoreEl = wrapper.querySelector('[data-flashcard-score]');
                const streakEl = wrapper.querySelector('[data-flashcard-streak]');
                const reviewedEl = wrapper.querySelector('[data-flashcard-reviewed]');
                const revealBtn = wrapper.querySelector('[data-flashcard-action="reveal"]');
                const knewBtn = wrapper.querySelector('[data-flashcard-action="knew"]');
                const didntBtn = wrapper.querySelector('[data-flashcard-action="didnt"]');
                const audioBtn = wrapper.querySelector('[data-flashcard-audio]');
                const imageEl = wrapper.querySelector('[data-flashcard-image]');
                const placeholderEl = wrapper.querySelector('[data-flashcard-placeholder]');
                const wordEl = wrapper.querySelector('[data-flashcard-word]');

                if (!cardEl || !revealBtn || !knewBtn || !didntBtn) {
                    return;
                }

                const submitButton = form ? form.querySelector('button[type="submit"]') : null;

                let queue = [];
                let missed = [];
                const missedTracker = Object.create(null);
                let activeCard = null;
                let audioRef = null;
                let isFlipped = false;
                let actionsLocked = false;
                let sessionPoints = 0;
                let streakCount = 0;
                let reviewedCount = 0;
                let cardStartTime = Date.now();

                const disableActions = function (state) {
                    const disabled = Boolean(state);
                    revealBtn.disabled = disabled || isFlipped;
                    knewBtn.disabled = disabled || !isFlipped;
                    didntBtn.disabled = disabled || !isFlipped;
                    actionsLocked = disabled;
                };

                const setSubmitAvailability = function (enabled) {
                    if (!submitButton) {
                        return;
                    }
                    submitButton.disabled = !enabled;
                    if (enabled) {
                        submitButton.removeAttribute('aria-disabled');
                    } else {
                        submitButton.setAttribute('aria-disabled', 'true');
                    }
                };

                const updateScoreboard = function () {
                    if (scoreEl) {
                        scoreEl.textContent = sessionPoints + ' pts';
                    }
                    if (streakEl) {
                        streakEl.textContent = 'Streak Â· ' + streakCount;
                    }
                    if (reviewedEl) {
                        reviewedEl.textContent = 'Reviewed Â· ' + reviewedCount;
                    }
                };

                const stopAudio = function () {
                    if (audioRef) {
                        try {
                            audioRef.pause();
                        } catch (error) {
                            console.warn('Unable to pause audio', error);
                        }
                    }
                };

                const setStatus = function (message) {
                    if (!statusEl) {
                        return;
                    }
                    statusEl.textContent = message || '';
                    statusEl.classList.toggle('d-none', !message);
                };

                const resetCardView = function () {
                    cardEl.classList.remove('flashcard-card--fly-left', 'flashcard-card--fly-right');
                    cardEl.classList.remove('is-flipped', 'd-none');
                    emptyEl && emptyEl.classList.add('d-none');
                    if (placeholderEl) {
                        placeholderEl.classList.remove('d-none');
                        placeholderEl.textContent = 'Tap to flip';
                    }
                    if (imageEl) {
                        imageEl.hidden = true;
                        imageEl.removeAttribute('src');
                    }
                    if (wordEl) {
                        wordEl.textContent = '';
                    }
                    if (audioBtn) {
                        audioBtn.disabled = true;
                    }
                    isFlipped = false;
                    disableActions(false);
                };

                const showCompletion = function () {
                    stopAudio();
                    cardEl.classList.add('d-none');
                    if (emptyEl) {
                        emptyEl.classList.remove('d-none');
                    }
                    if (summaryEl) {
                        const baseSummary = 'You reviewed ' + reviewedCount + ' word' + (reviewedCount === 1 ? '' : 's') + ' today.';
                        if (missed.length) {
                            summaryEl.textContent = baseSummary + ' Replay the tricky ones while they are fresh.';
                        } else {
                            summaryEl.textContent = baseSummary;
                        }
                    }
                    if (replayBtn) {
                        replayBtn.hidden = !missed.length;
                    }
                    disableActions(true);
                    if (!reviewedCount && !missed.length) {
                        setStatus('Nothing due right now. Tap â€œMark Doneâ€ to keep momentum.');
                    } else if (missed.length) {
                        setStatus('Great work. Replay the tricky words or tap â€œMark Doneâ€ to finish.');
                    } else {
                        setStatus('Daily review done. Tap â€œMark Doneâ€ to lock it in.');
                    }
                    setSubmitAvailability(true);
                };

                const renderCard = function (card) {
                    activeCard = card;
                    cardStartTime = Date.now();
                    resetCardView();
                    if (card && card.image_url && imageEl) {
                        imageEl.src = card.image_url;
                        imageEl.hidden = false;
                        placeholderEl && placeholderEl.classList.add('d-none');
                    } else if (placeholderEl) {
                        placeholderEl.classList.remove('d-none');
                        placeholderEl.textContent = 'Image coming soon';
                    }
                    if (wordEl) {
                        wordEl.textContent = (card && card.word) ? card.word.toUpperCase() : '';
                    }
                    if (audioBtn) {
                        audioBtn.disabled = !(card && card.audio_url);
                    }
                    disableActions(false);
                    setSubmitAvailability(false);
                    setStatus('Tap to flip the card.');
                };

                const advanceQueue = function () {
                    stopAudio();
                    if (queue.length) {
                        renderCard(queue.shift());
                        return;
                    }
                    if (missed.length) {
                        if (replayBtn) {
                            replayBtn.hidden = false;
                        }
                        showCompletion();
                        return;
                    }
                    showCompletion();
                };

                const recordOutcome = function (card, outcome, pointsAwarded, streakLength, timeSpent) {
                    const payload = {
                        card_id: card.id,
                        outcome: outcome,
                        points_awarded: pointsAwarded,
                        streak_length: streakLength,
                        time_spent_ms: timeSpent,
                    };
                    fetch(logUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfTokenGlobal,
                        },
                        body: JSON.stringify(payload),
                    }).catch(function (error) {
                        console.error('Unable to log flashcard outcome:', error);
                    });
                };

                const handleOutcome = function (outcome) {
                    if (!activeCard || actionsLocked) {
                        return;
                    }
                    if (!isFlipped) {
                        setStatus('Flip the card to check the word first.');
                        return;
                    }
                    disableActions(true);

                    const now = Date.now();
                    const timeSpent = Math.max(0, now - cardStartTime);
                    let points = 0;
                    if (outcome === 'knew') {
                        streakCount += 1;
                        points += 10;
                        if (streakCount > 0 && streakCount % 5 === 0) {
                            points += 25;
                        }
                        delete missedTracker[activeCard.id];
                        missed = missed.filter(function (item) {
                            return item.id !== activeCard.id;
                        });
                        cardEl.classList.add('flashcard-card--fly-right');
                        setStatus('Nice! +' + points + ' pts');
                    } else {
                        streakCount = 0;
                        points += 0;
                        if (!missedTracker[activeCard.id]) {
                            missedTracker[activeCard.id] = true;
                            missed.push({
                                id: activeCard.id,
                                word: activeCard.word,
                                image_url: activeCard.image_url,
                                audio_url: activeCard.audio_url,
                            });
                        }
                        cardEl.classList.add('flashcard-card--fly-left');
                        setStatus('We will repeat this word shortly.');
                    }
                    sessionPoints += points;
                    reviewedCount += 1;
                    updateScoreboard();
                    recordOutcome(activeCard, outcome === 'knew' ? 'knew' : 'didnt', points, streakCount, timeSpent);

                    const handledId = activeCard ? activeCard.id : null;
                    window.setTimeout(function () {
                        cardEl.classList.remove('flashcard-card--fly-left', 'flashcard-card--fly-right');
                        if (activeCard && activeCard.id === handledId) {
                            activeCard = null;
                        }
                        advanceQueue();
                    }, 360);
                };

                const revealCard = function () {
                    if (!activeCard || isFlipped || actionsLocked) {
                        return;
                    }
                    cardEl.classList.add('is-flipped');
                    isFlipped = true;
                    disableActions(false);
                    revealBtn.disabled = true;
                    knewBtn.disabled = false;
                    didntBtn.disabled = false;
                    setStatus('Did you know this word?');
                };

                const playAudio = function () {
                    if (!activeCard || !activeCard.audio_url) {
                        return;
                    }
                    try {
                        stopAudio();
                        audioRef = new Audio(activeCard.audio_url);
                        audioRef.play().catch(function (error) {
                            console.warn('Unable to play audio', error);
                            setStatus('Audio unavailable. Practice aloud anyway.');
                        });
                    } catch (error) {
                        console.warn('Audio init failed', error);
                    }
                };

                const refreshQueue = function () {
                    setStatus('Loading cardsâ€¦');
                    disableActions(true);
                    setSubmitAvailability(false);
                    stopAudio();
                    fetch(queueUrl, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                    })
                        .then(function (response) {
                            if (response.status === 403) {
                                return response.json().then(function (data) {
                                    if (data && data.redirect_url) {
                                        window.location.href = data.redirect_url;
                                    }
                                    throw new Error('Access denied');
                                });
                            }
                            if (!response.ok) {
                                throw new Error('Unable to load queue');
                            }
                            return response.json();
                        })
                        .then(function (data) {
                            queue = Array.isArray(data.cards) ? data.cards.slice() : [];
                            missed = [];
                            for (const key in missedTracker) {
                                if (Object.prototype.hasOwnProperty.call(missedTracker, key)) {
                                    delete missedTracker[key];
                                }
                            }
                            sessionPoints = 0;
                            streakCount = 0;
                            reviewedCount = 0;
                            updateScoreboard();
                            if (!queue.length) {
                                showCompletion();
                                return;
                            }
                            setStatus('');
                            renderCard(queue.shift());
                        })
                        .catch(function (error) {
                            console.error('Unable to load flashcards:', error);
                            setStatus('Unable to load cards. Refresh the page to try again.');
                            setSubmitAvailability(false);
                        });
                };

                cardEl.addEventListener('click', function () {
                    revealCard();
                });

                revealBtn.addEventListener('click', function () {
                    revealCard();
                });

                knewBtn.addEventListener('click', function () {
                    handleOutcome('knew');
                });

                didntBtn.addEventListener('click', function () {
                    handleOutcome('didnt');
                });

                if (audioBtn) {
                    audioBtn.addEventListener('click', function (event) {
                        event.stopPropagation();
                        playAudio();
                    });
                }

                if (replayBtn) {
                    replayBtn.addEventListener('click', function () {
                        if (!missed.length) {
                            return;
                        }
                        queue = missed.slice();
                        missed = [];
                        for (const key in missedTracker) {
                            if (Object.prototype.hasOwnProperty.call(missedTracker, key)) {
                                delete missedTracker[key];
                            }
                        }
                        if (emptyEl) {
                            emptyEl.classList.add('d-none');
                        }
                        cardEl.classList.remove('d-none');
                        replayBtn.hidden = true;
                        setSubmitAvailability(false);
                        renderCard(queue.shift());
                        setStatus('Replaying the words you missed.');
                    });
                }

                refreshQueue();
            });

            const letterGames = document.querySelectorAll('.letter-sequence-game');
            letterGames.forEach(function (game) {
                const form = game.closest('form');
                if (!form) {
                    return;
                }

                const submitButton = form.querySelector('button[type="submit"]');
                const wordRaw = (game.dataset.word || '').trim();
                const definition = (game.dataset.definition || '').trim();
                const letterBankEl = game.querySelector('[data-letter-bank]');
                const answerEl = game.querySelector('[data-letter-answer]');
                const resetBtn = game.querySelector('[data-letter-reset]');
                const errorEl = game.querySelector('[data-letter-error]');
                const definitionEl = game.querySelector('[data-letter-definition]');
                const missingEl = game.querySelector('[data-letter-missing]');

                const normalized = wordRaw.replace(/\s+/g, '').toUpperCase();

                const showDefinition = function () {
                    if (definitionEl) {
                        definitionEl.textContent = definition || 'Definition coming soon.';
                        definitionEl.classList.remove('d-none');
                    }
                };

                const showMissing = function () {
                    if (missingEl) {
                        missingEl.classList.remove('d-none');
                    }
                    if (letterBankEl) {
                        letterBankEl.innerHTML = '';
                    }
                    if (answerEl) {
                        answerEl.classList.add('d-none');
                    }
                    if (resetBtn) {
                        resetBtn.classList.add('d-none');
                    }
                    if (submitButton) {
                        submitButton.disabled = true;
                    }
                };

                if (!normalized) {
                    showMissing();
                    return;
                }

                const shuffle = function (array) {
                    const copy = array.slice();
                    for (let i = copy.length - 1; i > 0; i -= 1) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [copy[i], copy[j]] = [copy[j], copy[i]];
                    }
                    return copy;
                };

                const tileButtons = [];
                const originalWord = normalized;
                let scramble = [];
                let currentAnswer = [];

                const clearError = function () {
                    if (errorEl) {
                        errorEl.classList.add('d-none');
                    }
                };

                const updateAnswer = function () {
                    if (answerEl) {
                        answerEl.classList.remove('d-none');
                        answerEl.textContent = currentAnswer.join('');
                    }
                };

                const disableTiles = function () {
                    tileButtons.forEach(function (tile) {
                        tile.disabled = true;
                        tile.classList.add('letter-tile--used');
                    });
                };

                const solvedState = function () {
                    form.dataset.autoLock = 'true';
                    currentAnswer = originalWord.split('');
                    updateAnswer();
                    disableTiles();
                    if (resetBtn) {
                        resetBtn.disabled = true;
                    }
                    showDefinition();
                    clearError();
                    form.classList.add('afterburner-card--done');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.textContent = 'Completed';
                    }
                };

                const renderTiles = function () {
                    if (!letterBankEl) {
                        return;
                    }
                    letterBankEl.innerHTML = '';
                    tileButtons.length = 0;
                    scramble.forEach(function (letter, index) {
                        const tile = document.createElement('button');
                        tile.type = 'button';
                        tile.className = 'letter-tile';
                        tile.textContent = letter;
                        tile.dataset.index = String(index);
                        tile.addEventListener('click', function () {
                            if (tile.classList.contains('letter-tile--used')) {
                                return;
                            }
                            tile.classList.add('letter-tile--used');
                            tile.disabled = true;
                            currentAnswer.push(letter);
                            clearError();
                            updateAnswer();
                            checkCompletion();
                        });
                        tileButtons.push(tile);
                        letterBankEl.appendChild(tile);
                    });
                };

                const buildScramble = function () {
                    if (originalWord.length <= 1) {
                        scramble = originalWord.split('');
                        return;
                    }
                    let attempt = shuffle(originalWord.split(''));
                    if (attempt.join('') === originalWord) {
                        attempt = shuffle(originalWord.split(''));
                    }
                    scramble = attempt;
                };

                const resetGame = function () {
                    form.dataset.autoLock = 'false';
                    currentAnswer = [];
                    clearError();
                    if (definitionEl) {
                        definitionEl.classList.add('d-none');
                        definitionEl.textContent = '';
                    }
                    if (resetBtn) {
                        resetBtn.disabled = false;
                    }
                    buildScramble();
                    renderTiles();
                    updateAnswer();
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.textContent = 'Mark Done';
                    }
                };

                const checkCompletion = function () {
                    if (currentAnswer.join('') === originalWord) {
                        if (!form.classList.contains('afterburner-card--done')) {
                            solvedState();
                            form.requestSubmit();
                        }
                    } else if (currentAnswer.length === originalWord.length) {
                        if (errorEl) {
                            errorEl.textContent = 'Not quite right. Reset and try again.';
                            errorEl.classList.remove('d-none');
                        }
                    }
                };

                if (form.classList.contains('afterburner-card--done')) {
                    solvedState();
                    showDefinition();
                    return;
                }

                if (submitButton) {
                    submitButton.disabled = true;
                }

                resetGame();

                if (resetBtn) {
                    resetBtn.addEventListener('click', function () {
                        resetGame();
                    });
                }
            });
        })();
    </script>
    {% if stage_key == 'flight-deck' %}
        <script>
            (function () {
                const recorderCard = document.querySelector('.js-recorder-card');
                if (!recorderCard || !navigator.mediaDevices) {
                    return;
                }

                let mediaRecorder = null;
                let mediaRecorderMimeType = '';
                let activeStream = null;
                let recordedChunks = [];
                const statusEl = recorderCard.querySelector('.js-recorder-status');
                const audioEl = recorderCard.querySelector('.recorder-audio');
                const downloadEl = recorderCard.querySelector('.js-recorder-download');

                const setStatus = function (text) {
                    if (statusEl) {
                        statusEl.textContent = text;
                    }
                };

                const resetRecording = function () {
                    recordedChunks = [];
                    if (audioEl) {
                        audioEl.src = '';
                        audioEl.hidden = true;
                    }
                    if (downloadEl) {
                        downloadEl.hidden = true;
                        downloadEl.removeAttribute('href');
                    }
                };

                const handleDataAvailable = function (event) {
                    if (event.data && event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                const pickMimeType = function () {
                    const candidates = [
                        'audio/webm;codecs=opus',
                        'audio/webm',
                        'audio/mp4',
                        'audio/mp4;codecs=mp4a.40.2',
                    ];
                    for (let i = 0; i < candidates.length; i += 1) {
                        if (MediaRecorder.isTypeSupported(candidates[i])) {
                            return candidates[i];
                        }
                    }
                    return '';
                };

                const startRecording = function () {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        setStatus('Recording is not supported in this browser.');
                        return;
                    }
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        setStatus('Recording already in progressâ€¦ hit stop to finish.');
                        return;
                    }
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function (stream) {
                            resetRecording();
                            activeStream = stream;
                            mediaRecorderMimeType = pickMimeType();
                            const options = mediaRecorderMimeType ? { mimeType: mediaRecorderMimeType } : undefined;
                            try {
                                mediaRecorder = new MediaRecorder(stream, options);
                            } catch (error) {
                                console.error('Unable to create media recorder:', error);
                                setStatus('Recorder unavailable. Try a different browser.');
                                return;
                            }
                            mediaRecorder.ondataavailable = handleDataAvailable;
                            mediaRecorder.onstop = function () {
                                const blobType = mediaRecorderMimeType || 'audio/webm';
                                const blob = new Blob(recordedChunks, { type: blobType });
                                const url = URL.createObjectURL(blob);
                                if (audioEl) {
                                    audioEl.src = url;
                                    try {
                                        audioEl.load();
                                    } catch (error) {
                                        console.error('Unable to load audio element:', error);
                                    }
                                    audioEl.hidden = false;
                                }
                                if (downloadEl) {
                                    downloadEl.href = url;
                                    downloadEl.hidden = false;
                                }
                                setStatus('Recording ready. Hit play or download.');
                                mediaRecorder = null;
                            };
                            mediaRecorder.start();
                            setStatus('Recordingâ€¦ hit stop when you are ready.');
                        })
                        .catch(function (error) {
                            console.error('Unable to access microphone:', error);
                            setStatus('Microphone permission denied. Please enable audio access.');
                        });
                };

                const stopRecording = function () {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        setStatus('Processing recordingâ€¦');
                    }
                    if (activeStream) {
                        activeStream.getTracks().forEach(function (track) {
                            track.stop();
                        });
                        activeStream = null;
                    }
                };

                const playRecording = function () {
                    if (audioEl && audioEl.src) {
                        audioEl.play();
                    }
                };

                if (audioEl) {
                    audioEl.addEventListener('error', function () {
                        setStatus('Playback error. Try downloading the clip and playing locally.');
                    });
                }

                recorderCard.addEventListener('click', function (event) {
                    const control = event.target.closest('[data-recorder-action]');
                    if (!control) {
                        return;
                    }
                    event.preventDefault();
                    const action = control.getAttribute('data-recorder-action');
                    if (action === 'start') {
                        startRecording();
                    } else if (action === 'stop') {
                        stopRecording();
                    } else if (action === 'play') {
                        playRecording();
                    }
                });
            })();
        </script>
    {% endif %}
{% endblock %}
