{% extends "core/base.html" %}
{% block title %}{{ stage.label }} · {{ module.title }}{% endblock %}
{% block content %}
<section class="container-xl py-7">
    <div class="row g-5">
        <div class="col-lg-8">
            <article class="module-card glass-panel p-5 p-lg-6 mb-5" data-tilt="3">
                <p class="eyebrow mb-2">Stage {{ stage.order }} · {{ course.title }}</p>
                <h1 class="h3 fw-bold tracking-tight mb-2">{{ stage.label }} · {{ stage.tagline }}</h1>
                <p class="text-white-50 mb-4">{{ stage.summary }}</p>

                {% if stage_key == "launch-pad" %}
                    <div class="module-stage" data-animate="fade-up" data-animate-delay="0.05s">
                        <div class="stage-header">
                            <div>
                                <p class="eyebrow mb-1">NotebookLM missions</p>
                                <h2 class="h5 tracking-tight mb-1">Complete all six warmups before Friday</h2>
                            </div>
                            <p class="text-white-50 small mb-0">Links open in a new tab. Update with your NotebookLM workspace when ready.</p>
                        </div>
                        <div class="todo-grid">
                            {% if launch_pad_tasks %}
                                {% for task in launch_pad_tasks %}
                                    <form
                                        class="todo-card js-launch-task-form{% if task.completed %} todo-card--done{% endif %}"
                                        action="{% url 'course_module_stage_task_toggle' course.slug module.order stage_key task.index %}"
                                        method="post"
                                    >
                                        {% csrf_token %}
                                        <div class="todo-card__body">
                                            <span class="todo-step">0{{ task.index }}</span>
                                            <span class="todo-title">{{ task.title }}</span>
                                            {% if task.url %}
                                                <a class="todo-link" href="{{ task.url }}" target="_blank" rel="noopener">
                                                    Open NotebookLM
                                                </a>
                                            {% else %}
                                                <span class="todo-link">Open NotebookLM</span>
                                            {% endif %}
                                        </div>
                                        <button
                                            class="todo-check{% if task.completed %} todo-check--completed{% endif %}"
                                            type="submit"
                                            aria-pressed="{% if task.completed %}true{% else %}false{% endif %}"
                                        >
                                            {% if task.completed %}Done{% else %}Mark Done{% endif %}
                                        </button>
                                    </form>
                                {% endfor %}
                            {% else %}
                                {% for resource in pre_session_resources %}
                                    <a class="todo-card" href="{{ resource.url }}" target="_blank" rel="noopener">
                                        <span class="todo-step">0{{ forloop.counter }}</span>
                                        <span class="todo-title">{{ resource.title }}</span>
                                        <span class="todo-link">Open NotebookLM</span>
                                    </a>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                {% elif stage_key == "flight-deck" %}
                    <div class="module-stage" data-animate="fade-up" data-animate-delay="0.05s">
                        <div class="stage-header">
                            <div>
                                <p class="eyebrow mb-1">Live selections</p>
                                <h2 class="h5 tracking-tight mb-1">Lock your Friday studios</h2>
                            </div>
                            <p class="text-white-50 small mb-0">Pick the missions you plan to attend. Scheduling sync is coming soon.</p>
                        </div>
                        {% if sessions %}
                            <div class="meeting-grid">
                                {% for session in sessions %}
                                    <label class="meeting-option">
                                        <input type="checkbox" name="session_{{ session.id }}" />
                                        <div class="meeting-content">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h3 class="h6 mb-0">{{ session.title }}</h3>
                                                <span class="badge badge-soft">{{ session.duration_minutes }} min</span>
                                            </div>
                                            <p class="text-white-50 small mb-1">{{ session.get_session_type_display }}</p>
                                            {% if session.description %}
                                                <p class="text-white-50 small mb-0">{{ session.description|linebreaksbr }}</p>
                                            {% endif %}
                                            {% if session.resources %}
                                                <ul class="text-white-50 small mb-0 list-unstyled d-grid gap-1 mt-2">
                                                    {% for resource in session.resources %}
                                                        <li>• {{ resource.label }}: {{ resource.detail }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <p class="text-white-50 small mb-0">Selections save to your profile soon. For now, screenshot to remember.</p>
                                <button class="btn btn-outline-light btn-sm" type="button" disabled>Confirm picks</button>
                            </div>
                        {% else %}
                            <p class="text-white-50 small mb-0">Live studio schedule will be announced shortly.</p>
                        {% endif %}
                    </div>
                {% elif stage_key == "afterburner" %}
                    <div class="module-stage" data-animate="fade-up" data-animate-delay="0.05s">
                        <div class="stage-header">
                            <div>
                                <p class="eyebrow mb-1">Retention lab</p>
                                <h2 class="h5 tracking-tight mb-1">Play, review, and lock in the gains</h2>
                            </div>
                            <p class="text-white-50 small mb-0">Blend games with spaced repetition to encode what you learned.</p>
                        </div>
                        <div class="post-grid">
                            <div>
                                <h3 class="h6 mb-2">Arcade Boosters</h3>
                                <ul class="post-list">
                                    {% for item in post_session_games %}
                                        <li>{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div>
                                <h3 class="h6 mb-2">Repetition Loops</h3>
                                <ul class="post-list">
                                    {% for item in post_session_loops %}
                                        <li>{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </article>
        </div>
        <div class="col-lg-4">
            <aside class="glass-panel p-4 p-lg-5" data-tilt="4">
                <p class="eyebrow mb-2">Stage navigation</p>
                <div class="stage-nav d-grid gap-2 mb-4">
                    {% for item in stage_cards %}
                        {% if item.is_unlocked %}
                            <a
                                class="stage-nav-link{% if item.is_active %} active{% endif %}"
                                href="{{ item.url }}"
                                data-stage-nav="{{ item.key }}"
                                data-stage-url="{{ item.url }}"
                            >
                                <span class="stage-nav-text">
                                    <span class="stage-nav-label">Stage {{ item.order }}</span>
                                    <span class="stage-nav-title">{{ item.label }}</span>
                                </span>
                                <span class="stage-nav-lock module-lock module-lock--compact" aria-hidden="true">
                                    <svg class="lock-icon lock-icon--closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M8.5 10.5v-2.8a3.5 3.5 0 0 1 7 0v2.8" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                    <svg class="lock-icon lock-icon--open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M15.5 10.5v-2.8a3.5 3.5 0 1 0-7 0" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                </span>
                            </a>
                        {% else %}
                            <span
                                class="stage-nav-link stage-nav-link--locked{% if item.is_active %} active{% endif %}"
                                role="button"
                                aria-disabled="true"
                                tabindex="-1"
                                data-stage-nav="{{ item.key }}"
                                data-stage-url="{{ item.url }}"
                            >
                                <span class="stage-nav-text">
                                    <span class="stage-nav-label">Stage {{ item.order }}</span>
                                    <span class="stage-nav-title">{{ item.label }}</span>
                                </span>
                                <span class="stage-nav-lock module-lock module-lock--compact" aria-hidden="true">
                                    <svg class="lock-icon lock-icon--closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M8.5 10.5v-2.8a3.5 3.5 0 0 1 7 0v2.8" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                    <svg class="lock-icon lock-icon--open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <rect x="5.5" y="10.5" width="13" height="9" rx="2.5" />
                                        <path d="M15.5 10.5v-2.8a3.5 3.5 0 1 0-7 0" />
                                        <circle cx="12" cy="15.5" r="1.4" />
                                    </svg>
                                </span>
                            </span>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="d-grid gap-2">
                    <a class="btn btn-light" href="{% url 'course_module' course.slug module.order %}">Back to week overview</a>
                    <a class="btn btn-outline-light" href="{% url 'course_detail' course.slug %}">All weeks</a>
                </div>
            </aside>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    <script>
        (function () {
            const toArray = function (list) {
                return Array.prototype.slice.call(list || []);
            };

            const unique = function (items) {
                const seen = Object.create(null);
                const result = [];
                for (let idx = 0; idx < items.length; idx += 1) {
                    const value = items[idx];
                    if (!value || seen[value]) {
                        continue;
                    }
                    seen[value] = true;
                    result.push(value);
                }
                return result;
            };

            const forms = document.querySelectorAll('.js-launch-task-form');
            if (!forms.length) {
                return;
            }

            const updateNav = function (stageKey, unlocked) {
                const navEl = document.querySelector('[data-stage-nav="' + stageKey + '"]');
                if (!navEl) {
                    return;
                }

                const stageUrl = navEl.dataset.stageUrl || navEl.getAttribute('href') || '';

                if (unlocked) {
                    if (navEl.tagName === 'SPAN') {
                        const link = document.createElement('a');
                        const linkClasses = toArray(navEl.classList)
                            .filter(function (className) {
                                return className !== 'stage-nav-link--locked';
                            });
                        link.className = linkClasses.join(' ') || 'stage-nav-link';
                        if (!link.classList.contains('stage-nav-link')) {
                            link.classList.add('stage-nav-link');
                        }
                        if (navEl.classList.contains('active')) {
                            link.classList.add('active');
                        }
                        link.href = stageUrl;
                        link.dataset.stageNav = stageKey;
                        link.dataset.stageUrl = stageUrl;
                        link.classList.remove('stage-nav-link--locked');
                        link.innerHTML = navEl.innerHTML;
                        navEl.replaceWith(link);
                        return;
                    }
                    navEl.classList.remove('stage-nav-link--locked');
                    if (stageUrl) {
                        navEl.setAttribute('href', stageUrl);
                    }
                    navEl.removeAttribute('aria-disabled');
                    navEl.removeAttribute('tabindex');
                    return;
                }

                if (navEl.tagName === 'A') {
                    const span = document.createElement('span');
                    const spanClasses = toArray(navEl.classList);
                    spanClasses.push('stage-nav-link--locked');
                    span.className = unique(spanClasses).join(' ');
                    if (!span.classList.contains('stage-nav-link')) {
                        span.classList.add('stage-nav-link');
                    }
                    if (navEl.classList.contains('active')) {
                        span.classList.add('active');
                    }
                    span.dataset.stageNav = stageKey;
                    span.dataset.stageUrl = stageUrl;
                    span.setAttribute('role', 'button');
                    span.setAttribute('aria-disabled', 'true');
                    span.setAttribute('tabindex', '-1');
                    span.innerHTML = navEl.innerHTML;
                    navEl.replaceWith(span);
                }
            };

            forms.forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const submitButton = form.querySelector('.todo-check');
                    if (!submitButton) {
                        return;
                    }
                    const csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
                    const csrfToken = csrfInput ? csrfInput.value : '';
                    const formData = new FormData(form);

                    submitButton.disabled = true;

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: formData,
                    })
                        .then(function (response) {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(function (data) {
                            const completed = Boolean(data.completed);
                            form.classList.toggle('todo-card--done', completed);
                            submitButton.classList.toggle('todo-check--completed', completed);
                            submitButton.textContent = completed ? 'Done' : 'Mark Done';
                            submitButton.setAttribute('aria-pressed', completed ? 'true' : 'false');

                            if (data.stage_unlocks && typeof data.stage_unlocks === 'object') {
                                if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'flight-deck')) {
                                    updateNav('flight-deck', Boolean(data.stage_unlocks['flight-deck']));
                                }
                                if (Object.prototype.hasOwnProperty.call(data.stage_unlocks, 'afterburner')) {
                                    updateNav('afterburner', Boolean(data.stage_unlocks['afterburner']));
                                }
                            }
                        })
                        .catch(function (error) {
                            console.error('Unable to toggle task state via AJAX:', error);
                        })
                        .finally(function () {
                            submitButton.disabled = false;
                        });
                });
            });
        })();
    </script>
{% endblock %}
