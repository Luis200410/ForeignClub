{% extends "core/base.html" %}
{% block title %}Command Center · FOREIGN{% endblock %}
{% block content %}

{% if not dashboard_ready %}
<section class="section-kinetic" style="min-height: 60vh; align-items: center;">
    <div class="container text-center">
        <h1 class="h2 text-neon mb-3">Initializing Command Center...</h1>
        <p class="text-ink-dim">Syncing your profile. Please refresh in a moment.</p>
    </div>
</section>
{% else %}

<!-- Hero / Stats -->
<section class="section-kinetic pt-7 pb-5">
    <div class="container">
        <div class="row align-items-end mb-6">
            <div class="col-lg-8">
                <p class="text-neon text-uppercase tracking-widest mb-2">Command Center</p>
                <h1 class="display-xl" data-scroll>Welcome back, <span class="text-white">{{
                        profile.display_name|default:user.get_username }}</span>.</h1>
            </div>
            <div class="col-lg-4 text-lg-end">
                <p class="lead text-ink-dim">{{ profile.headline|default:"Your journey continues." }}</p>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="row g-4 mb-6">
            <div class="col-6 col-md-3" data-scroll>
                <div class="p-4 border border-light rounded-4 bg-surface-highlight h-100">
                    <p class="text-ink-dim text-uppercase small mb-2">Active Goals</p>
                    <p class="display-4 text-neon mb-0">{{ stats.total_goals|default:0 }}</p>
                </div>
            </div>
            <div class="col-6 col-md-3" data-scroll>
                <div class="p-4 border border-light rounded-4 bg-surface-highlight h-100">
                    <p class="text-ink-dim text-uppercase small mb-2">Live Windows</p>
                    <p class="display-4 text-white mb-0">{{ stats.engagement_windows|default:0 }}</p>
                </div>
            </div>
            <div class="col-6 col-md-3" data-scroll>
                <div class="p-4 border border-light rounded-4 bg-surface-highlight h-100">
                    <p class="text-ink-dim text-uppercase small mb-2">Progress Notes</p>
                    <p class="display-4 text-white mb-0">{{ stats.progress_notes|default:0 }}</p>
                </div>
            </div>
            <div class="col-6 col-md-3" data-scroll>
                <div class="p-4 border border-light rounded-4 bg-surface-highlight h-100">
                    <p class="text-ink-dim text-uppercase small mb-2">Fluency Level</p>
                    <p class="display-4 text-neon mb-0">
                        {% if stats.last_assessment %}
                        {{ stats.last_assessment.get_fluency_level_display|slice:":2" }}
                        {% else %}
                        --
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Active Course -->
{% if active_enrollments %}
<section class="section-kinetic pb-5">
    <div class="container">
        <div class="sticky-card" style="background: var(--primary); color: var(--ink-dark);">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <p class="text-uppercase tracking-widest mb-2" style="opacity: 0.7;">Current Mission</p>
                    <h2 class="display-4 mb-3">{{ primary_course.title }}</h2>
                    <p class="lead mb-4" style="opacity: 0.8;">{{ primary_course.subtitle|default:"Continue your active
                        module." }}</p>
                    <a href="{% url 'course_detail' primary_course.slug %}"
                        class="btn btn-dark rounded-pill px-4 py-2">Resume Mission</a>
                </div>
                <div class="col-lg-4 d-none d-lg-block text-end">
                    <span class="display-1" style="opacity: 0.2;">→</span>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Goals & Progress -->
<section class="section-kinetic pb-7">
    <div class="container">
        <div class="row g-5">
            <!-- Goals -->
            <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h2 text-white">Mission Priority</h3>
                    <a href="{% url 'manage_goal' %}"
                        class="text-neon text-uppercase tracking-widest small text-decoration-none">Update</a>
                </div>

                {% if primary_goal %}
                <div class="sticky-card" style="margin-bottom: 2rem; padding: 2rem;">
                    <span class="badge bg-neon text-dark mb-3">{{ primary_goal.get_focus_area_display }}</span>
                    <h4 class="h3 mb-3">{{ primary_goal.title }}</h4>
                    <p class="text-ink-dim mb-0">{{ primary_goal.success_metric }}</p>
                </div>
                {% else %}
                <div class="p-5 border border-light rounded-4 text-center">
                    <p class="text-ink-dim mb-3">No active mission.</p>
                    <a href="{% url 'manage_goal' %}" class="btn-kinetic">Set Goal</a>
                </div>
                {% endif %}

                {% if secondary_goals %}
                <div class="mt-4">
                    <p class="text-ink-dim text-uppercase small mb-3">Supporting Objectives</p>
                    {% for goal in secondary_goals %}
                    <div class="p-3 border border-light rounded-3 mb-3 bg-surface-highlight">
                        <div class="d-flex justify-content-between">
                            <span class="text-white">{{ goal.title }}</span>
                            <span class="text-neon small">{{ goal.get_focus_area_display }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Progress -->
            <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h2 text-white">Momentum</h3>
                    <a href="{% url 'progress_add' %}"
                        class="text-neon text-uppercase tracking-widest small text-decoration-none">Log</a>
                </div>

                {% if recent_progress %}
                <div class="d-flex flex-column gap-3">
                    {% for entry in recent_progress %}
                    <div class="p-4 border border-light rounded-4 bg-surface-highlight hover-3d">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-neon small">{{ entry.logged_at|date:"M j" }}</span>
                            <span class="text-ink-dim small">Impact: {{ entry.impact_rating }}/5</span>
                        </div>
                        <h4 class="h5 mb-2">{{ entry.summary }}</h4>
                        <p class="text-ink-dim small mb-0">{{ entry.details|truncatechars:100 }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-5 border border-light rounded-4 text-center">
                    <p class="text-ink-dim mb-3">No progress logged yet.</p>
                    <a href="{% url 'progress_add' %}" class="btn-kinetic">Log First Win</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

{% endif %}
{% endblock %}